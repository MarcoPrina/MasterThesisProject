<html>

	<label for="corso">Cerca un corso:</label>
	<p>Suggerimento: <span id="txtHint"></span></p>
	<input type='text' id='corso' onkeyup="showHint(this.value)">
	<button class="btnSearch" id="btnCorso" type='button' onclick='findCorso()'>Carca</button>
	<input type='hidden' id='corsoID'><br><br>

	<label for="lezione">Puoi selezionare una lezione specifica:</label>
	<select name="lezione" id="lezione" disabled></select><br><br>

	<label for="query">Cerca una o due parole chiave:</label>
	<input type='text' id='query' disabled>
	<button class="btnSearch" type='button' id='querybtn' onclick='query()' disabled>Carca</button><br><br>
	<div id="result"></div>



</html>

<script>
var corsoInput = document.getElementById("corso");

// Execute a function when the user releases a key on the keyboard
corsoInput.addEventListener("keyup", function(event) {
  // Number 13 is the "Enter" key on the keyboard
  if (event.keyCode === 13) {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    document.getElementById("btnCorso").click();
  }
});

var queryInput = document.getElementById("query");

// Execute a function when the user releases a key on the keyboard
queryInput.addEventListener("keyup", function(event) {
  // Number 13 is the "Enter" key on the keyboard
  if (event.keyCode === 13) {
    // Cancel the default action, if needed
    event.preventDefault();
    // Trigger the button element with a click
    document.getElementById("querybtn").click();
  }
});

function showHint(str) {
	document.getElementById("txtHint").innerHTML = "";
    if (str.length > 1) {
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.responseType = 'json'
		xmlhttp.onreadystatechange = function() {
			if (this.readyState === 4 && this.status === 200) {
				var div = document.createElement('div');
				if(this.response.length === 0){
					div.innerText = "Nessun risultato trovato, provare con altri nomi"
				}
				else	{
					for(var i = 0, l = this.response.length -1; i < l; i++){
						var link = document.createElement('a');
						link.innerHTML = this.response[i].nome + ', ';
						link.setAttribute('onclick', "selectedCorso('" + this.response[i].nome + "')");
						div.appendChild(link)
					}
					var link = document.createElement('a');
          link.innerHTML = this.response[this.response.length -1].nome + '.';
          link.setAttribute('onclick', "selectedCorso('" + this.response[this.response.length -1].nome + "')");
          div.appendChild(link)
				}
				document.getElementById("txtHint").appendChild(div);
			}
		};
		xmlhttp.open("GET", "http://localhost:8000/corso/hint?hint=" + str, true);
		xmlhttp.send();
	}
}

function selectedCorso(corso) {
	document.getElementById("corso").value = corso
	findCorso()
}


function findCorso() {
	var corso = document.getElementById("corso").value;
	var xhr = new XMLHttpRequest();
	xhr.responseType = 'json'
	xhr.open("GET", "http://localhost:8000/corso?nome=" + corso, true);
	//xhr.setRequestHeader("X-My-Custom-Header", "some value");
	xhr.onreadystatechange = function() {
		if (this.readyState === 4 && this.status === 200) {
			document.getElementById('query').disabled = false
			document.getElementById('querybtn').disabled = false
			document.getElementById('corsoID').value = this.response.id
			setLezioni(this.response.id);
		}
	};
	xhr.send();
}

function setLezioni(IDcorso) {
	var xhr = new XMLHttpRequest();
	xhr.responseType = 'json'
	xhr.open("GET", "http://localhost:8000/corso/" + IDcorso, true);
	//xhr.setRequestHeader("X-My-Custom-Header", "some value");
	xhr.onreadystatechange = function() {
		if (this.readyState === 4 && this.status === 200) {

			let lezione = document.getElementById('lezione')
			lezione.disabled = false
			let optionList = lezione.options;
			let options = this.response

			optionList.add(new Option("Tutte", ""));

			for(var i = 0, l = options.length; i < l; i++){
				var option = options[i];
				optionList.add(new Option(option.nome, option.id));
			}
		}
	};
	xhr.send();
}

function query() {
	var corso = document.getElementById("corsoID").value;
	var lezione = document.getElementById("lezione").value;
	var query = document.getElementById("query").value;
	var xhr = new XMLHttpRequest();
	xhr.responseType = 'json'
	xhr.open("GET", "http://localhost:8000/search?corso=" + corso + "&lezione=" + lezione + "&query=" + query, true); // da aggiustare
	//xhr.setRequestHeader("X-My-Custom-Header", "some value");
	xhr.onreadystatechange = function() {
		if (this.readyState === 4 && this.status === 200) {
			document.getElementById("result").innerHTML = "";
			document.getElementById('result').appendChild(makeBinomiList(this.response));
		}
	};
	xhr.send();
}

function makeBinomiList(array) {
	var list = document.createElement('ul');

	for(var i = 0; i < array.length; i++) {
		var item = document.createElement('li');
		var link = document.createElement('a');
		//link.setAttribute('href', '#');

		var divId = array[i].word.replace(/[^a-zA-Z]/g, "")
		link.setAttribute('onclick', "toggleTimeList('"+ divId + "')");
		link.innerHTML = array[i].word;


		var div = document.createElement('div');
		div.setAttribute('id',divId);
		div.style.display = "none";
		div.appendChild(makeTimeList(array[i].list))

		item.appendChild(link);
		item.appendChild(div);

		list.appendChild(item);
	}

	return list;
}



function makeTimeList(time_list) {
  var list = document.createElement('ul');

  for(var i = 0; i < time_list.length; i++) {
    var item = document.createElement('li');
    var link = document.createElement('a');
    var time = time_list[i].time_stamp.split(':')
    var offset =  Number(time[0])*60*60 +  Number(time[1])*60 +  Number(time[2].split('.')[0])
    if (offset > 5)
      offset -= 5
    link.setAttribute('href', time_list[i].lezione.kiro_url + '#t=' + offset);
    link.innerHTML = time_list[i].lezione.nome + ': ' + time_list[i].time_stamp;

    item.appendChild(link);
    list.appendChild(item);
  }
  return list
}

function toggleTimeList(divID) {
  var x = document.getElementById(divID);
  if (x.style.display === 'none') {
    x.style.display = 'block';
  } else {
    x.style.display = 'none';
  }
}

</script>

<style>
  .btnSearch {
      margin-bottom: 10px;
      margin-left: 10px;
  }

</style>
